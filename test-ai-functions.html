<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Functions Test - マスマジ！</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-600 via-purple-500 to-pink-500">

    <!-- ヘッダー -->
    <header class="bg-white/10 backdrop-blur-md shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold text-white">
                <i class="fas fa-flask mr-2"></i>
                AI Functions テスト
            </h1>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="container mx-auto px-4 py-8">
        <div class="max-w-4xl mx-auto">

            <!-- 説明 -->
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                    テストについて
                </h2>
                <p class="text-gray-700 mb-4">
                    このページでは、Netlify Functions（AI問題生成、ヒント生成、解説生成）が正しく動作するかテストします。
                </p>
                <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                    <p class="text-sm text-gray-800">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                        <strong>注意:</strong> このテストは開発環境では動作しません。Netlifyにデプロイ後、環境変数<code class="bg-gray-200 px-1 rounded">OPENAI_API_KEY</code>を設定してから実行してください。
                    </p>
                </div>
            </div>

            <!-- テスト1: 問題生成 -->
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-1 text-purple-600 mr-2"></i>
                    問題生成テスト
                </h2>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">学年</label>
                        <select id="test1-grade" class="w-full p-2 border-2 border-gray-300 rounded-lg">
                            <option value="3">小学3年生</option>
                            <option value="4">小学4年生</option>
                            <option value="5">小学5年生</option>
                            <option value="6">小学6年生</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">難易度</label>
                        <select id="test1-difficulty" class="w-full p-2 border-2 border-gray-300 rounded-lg">
                            <option value="easy">かんたん</option>
                            <option value="normal">ふつう</option>
                            <option value="hard">むずかしい</option>
                        </select>
                    </div>
                </div>

                <button id="test1-btn" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform hover:scale-105">
                    <i class="fas fa-play mr-2"></i>問題を生成
                </button>

                <div id="test1-result" class="mt-4 hidden">
                    <div class="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-2">結果:</h3>
                        <pre id="test1-output" class="text-sm text-gray-700 whitespace-pre-wrap overflow-x-auto"></pre>
                    </div>
                </div>

                <div id="test1-loading" class="mt-4 hidden text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                    <p class="text-gray-700 mt-2">AI が問題を生成中...</p>
                </div>
            </div>

            <!-- テスト2: ヒント生成 -->
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-2 text-blue-600 mr-2"></i>
                    ヒント生成テスト
                </h2>

                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ヒントレベル</label>
                    <select id="test2-hint-level" class="w-full p-2 border-2 border-gray-300 rounded-lg">
                        <option value="1">レベル1（考え方の方向性）</option>
                        <option value="2">レベル2（具体的な手順）</option>
                        <option value="3">レベル3（答えに近いヒント）</option>
                    </select>
                </div>

                <button id="test2-btn" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform hover:scale-105">
                    <i class="fas fa-lightbulb mr-2"></i>ヒントを生成
                </button>

                <div id="test2-result" class="mt-4 hidden">
                    <div class="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-2">結果:</h3>
                        <pre id="test2-output" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                    </div>
                </div>

                <div id="test2-loading" class="mt-4 hidden text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="text-gray-700 mt-2">AI がヒントを生成中...</p>
                </div>
            </div>

            <!-- テスト3: 解説生成 -->
            <div class="bg-white/90 backdrop-blur-sm rounded-2xl p-6 shadow-xl mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-3 text-green-600 mr-2"></i>
                    解説生成テスト
                </h2>

                <button id="test3-btn" class="w-full bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform hover:scale-105">
                    <i class="fas fa-book mr-2"></i>解説を生成
                </button>

                <div id="test3-result" class="mt-4 hidden">
                    <div class="bg-gray-50 rounded-lg p-4 border-2 border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-2">結果:</h3>
                        <pre id="test3-output" class="text-sm text-gray-700 whitespace-pre-wrap"></pre>
                    </div>
                </div>

                <div id="test3-loading" class="mt-4 hidden text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
                    <p class="text-gray-700 mt-2">AI が解説を生成中...</p>
                </div>
            </div>

            <!-- 戻るボタン -->
            <div class="text-center">
                <a href="index.html" class="inline-block bg-white/20 hover:bg-white/30 text-white font-bold py-3 px-6 rounded-full transition">
                    <i class="fas fa-arrow-left mr-2"></i>トップへ戻る
                </a>
            </div>

        </div>
    </main>

    <script>
        // テスト用のサンプル問題
        let testProblem = null;

        // テスト1: 問題生成
        document.getElementById('test1-btn').addEventListener('click', async () => {
            const grade = document.getElementById('test1-grade').value;
            const difficulty = document.getElementById('test1-difficulty').value;

            const loading = document.getElementById('test1-loading');
            const result = document.getElementById('test1-result');
            const output = document.getElementById('test1-output');

            loading.classList.remove('hidden');
            result.classList.add('hidden');

            try {
                const response = await fetch('/.netlify/functions/generate-problem', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        grade: parseInt(grade),
                        worldId: 'multiplication_forest',
                        difficulty: difficulty
                    })
                });

                const data = await response.json();

                loading.classList.add('hidden');
                result.classList.remove('hidden');

                if (data.success) {
                    testProblem = data.problem;
                    output.textContent = JSON.stringify(data.problem, null, 2);
                    output.classList.remove('text-red-600');
                    output.classList.add('text-gray-700');
                } else {
                    output.textContent = `エラー: ${data.error}`;
                    output.classList.add('text-red-600');
                }
            } catch (error) {
                loading.classList.add('hidden');
                result.classList.remove('hidden');
                output.textContent = `エラー: ${error.message}\n\n開発環境ではNetlify Functionsは動作しません。Netlifyにデプロイしてテストしてください。`;
                output.classList.add('text-red-600');
            }
        });

        // テスト2: ヒント生成
        document.getElementById('test2-btn').addEventListener('click', async () => {
            if (!testProblem) {
                alert('まず問題生成テストを実行してください');
                return;
            }

            const hintLevel = parseInt(document.getElementById('test2-hint-level').value);

            const loading = document.getElementById('test2-loading');
            const result = document.getElementById('test2-result');
            const output = document.getElementById('test2-output');

            loading.classList.remove('hidden');
            result.classList.add('hidden');

            try {
                const response = await fetch('/.netlify/functions/generate-hint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        problem: testProblem,
                        hintLevel: hintLevel,
                        grade: 3
                    })
                });

                const data = await response.json();

                loading.classList.add('hidden');
                result.classList.remove('hidden');

                if (data.success) {
                    output.textContent = `ヒントレベル${data.hintLevel}:\n${data.hint}`;
                    output.classList.remove('text-red-600');
                    output.classList.add('text-gray-700');
                } else {
                    output.textContent = `エラー: ${data.error}`;
                    output.classList.add('text-red-600');
                }
            } catch (error) {
                loading.classList.add('hidden');
                result.classList.remove('hidden');
                output.textContent = `エラー: ${error.message}\n\n開発環境ではNetlify Functionsは動作しません。Netlifyにデプロイしてテストしてください。`;
                output.classList.add('text-red-600');
            }
        });

        // テスト3: 解説生成
        document.getElementById('test3-btn').addEventListener('click', async () => {
            if (!testProblem) {
                alert('まず問題生成テストを実行してください');
                return;
            }

            const loading = document.getElementById('test3-loading');
            const result = document.getElementById('test3-result');
            const output = document.getElementById('test3-output');

            loading.classList.remove('hidden');
            result.classList.add('hidden');

            try {
                const response = await fetch('/.netlify/functions/generate-explanation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        problem: testProblem,
                        grade: 3,
                        userAnswer: testProblem.answer
                    })
                });

                const data = await response.json();

                loading.classList.add('hidden');
                result.classList.remove('hidden');

                if (data.success) {
                    output.textContent = data.explanation;
                    output.classList.remove('text-red-600');
                    output.classList.add('text-gray-700');
                } else {
                    output.textContent = `エラー: ${data.error}`;
                    output.classList.add('text-red-600');
                }
            } catch (error) {
                loading.classList.add('hidden');
                result.classList.remove('hidden');
                output.textContent = `エラー: ${error.message}\n\n開発環境ではNetlify Functionsは動作しません。Netlifyにデプロイしてテストしてください。`;
                output.classList.add('text-red-600');
            }
        });
    </script>

</body>
</html>
