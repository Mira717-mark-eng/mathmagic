# ストーリーシステム実装ガイド

## 📖 概要

マスマジ！にストーリーシステムを実装しました。各クエストにRPG風のストーリーが追加され、学習がより楽しくなります。

## ✨ 実装済み機能

### 1. ストーリーファイル（優先3学年）

以下の3学年のストーリーが完成しています：

#### 🎓 中学1年（jh1-story.json）
- **タイトル**: 数理世界の守護者
- **テーマ**: 正と負の世界のバランスを取り戻す
- **章数**: 3章（8クエスト）
  - 第1章: 正と負の二つの世界（quest01-03）
  - 第2章: 関数と図形の調和（quest04-06）
  - 第3章: 統計と確率、そして最終試練（quest07-08）
- **学習内容**: 正負の数、文字式、方程式、比例、図形、データ分析、確率

#### 📚 小学4年（grade4-story.json）
- **タイトル**: 億兆の宇宙と図形の秘密
- **テーマ**: 宇宙を冒険し、大きな数と図形の謎を解く
- **章数**: 4章（14クエスト）
  - 第1章: 億と兆の宇宙へ（quest01-03）
  - 第2章: 小数と面積の惑星（quest04-07）
  - 第3章: 図形の秘密と直方体の城（quest08-11）
  - 第4章: 立体の城と最終試練（quest12-14）
- **学習内容**: 億兆の数、割り算、角度、小数、面積、分数、垂直平行、がい数、グラフ、立体

#### 🌳 小学2年（grade2-story.json）
- **タイトル**: 数の森の守護者たち
- **テーマ**: 数の森を救い、協力と工夫で問題を解決
- **章数**: 3章（10クエスト）
  - 第1章: 数の森の危機（quest01-04）
  - 第2章: かけ算の塔と時の神殿（quest05-07）
  - 第3章: 図形の神殿と最終試練（quest08-10）
- **学習内容**: 100までの数、筆算、長さ、九九、時刻、1000までの数、図形、箱の形、分数

## 🏗️ システム構成

### ファイル構成

```
mathmagic/
├── js/
│   ├── story-system.js          # ストーリーシステム本体
│   ├── quest.js                 # クエスト画面（ストーリー統合済み）
│   └── stories/                 # ストーリーデータディレクトリ
│       ├── grade1-story.json    # 小学1年
│       ├── grade2-story.json    ✅ # 小学2年（完成）
│       ├── grade4-story.json    ✅ # 小学4年（完成）
│       └── jh1-story.json       ✅ # 中学1年（完成）
```

### ストーリーJSONの構造

```json
{
  "gradeId": "grade2",
  "storyTitle": "数の森の守護者たち",
  "description": "100までの数、かけ算の魔法、そして図形の謎を解き明かす冒険",
  "mainTheme": "協力と工夫で、どんな問題も解決できる",
  "chapters": [
    {
      "chapterId": 1,
      "title": "第1章: 数の森の危機",
      "questIds": ["grade2-quest01", "grade2-quest02", ...],
      "recommendedLevel": 4,
      "intro": "章の導入テキスト",
      "questStories": {
        "grade2-quest01": {
          "before": "クエスト開始前のストーリー",
          "after": "クエスト完了後のストーリー",
          "npcDialogue": "NPCの台詞"
        }
      },
      "chapterEnd": "章の完了メッセージ"
    }
  ],
  "epilogue": "エピローグ"
}
```

## 🎮 ゲームフロー

### 1. クエスト開始時

```
ワールドマップでクエスト選択
↓
quest.htmlに遷移
↓
StorySystem.loadStoryForGrade() でストーリー読み込み
↓
showStoryIntro() でストーリーイントロを表示
↓
プレイヤーが「クエスト開始」ボタンをクリック
↓
問題表示開始
```

**表示内容**:
- キャラクター情報（名前・アイコン）
- 章のタイトル
- ストーリーテキスト（before）
- NPCの台詞
- 「クエスト開始」ボタン

### 2. クエスト完了時

```
最後の問題に回答
↓
finishQuest() が呼ばれる
↓
正解率からクリアステータスを判定
  - 80%以上: perfect
  - 50%以上: clear
  - 50%未満: failed
↓
showStoryOutro() でストーリーアウトロを表示
↓
プレイヤーが「次へ」ボタンをクリック
↓
ワールドマップに戻る
```

**表示内容**:
- キャラクター情報
- クリアステータス（パーフェクト/クリア/失敗）
- ストーリーテキスト（after）
- NPCの台詞
- 章の完了メッセージ（該当する場合）
- 「次へ」ボタン

## 💻 技術的な実装

### js/story-system.js の主要関数

#### `StorySystem.loadStoryForGrade(gradeId)`
指定された学年のストーリーファイルを読み込みます。

```javascript
const storyData = await StorySystem.loadStoryForGrade('grade2');
// js/stories/grade2-story.json を読み込む
```

#### `StorySystem.getQuestStory(questId)`
現在読み込まれているストーリーから、指定されたクエストのストーリーデータを取得します。

```javascript
const questStory = StorySystem.getQuestStory('grade2-quest01');
// { before: "...", after: "...", npcDialogue: "..." }
```

#### `StorySystem.showQuestIntro(questId, containerElement)`
クエスト開始前のストーリーイントロをHTMLとして生成し、コンテナに挿入します。

#### `StorySystem.showQuestOutro(questId, containerElement, clearStatus)`
クエスト完了後のストーリーアウトロをHTMLとして生成し、コンテナに挿入します。

### js/quest.js の統合ポイント

#### 1. ストーリーシステムの初期化（initQuestSession）

```javascript
async function initQuestSession() {
    // ... 既存の初期化処理 ...

    // ストーリーシステムを初期化
    await initStorySystem(session.questId);
}
```

#### 2. ストーリーイントロの表示（displayProblem）

```javascript
async function displayProblem() {
    // 最初の問題でストーリーイントロを表示
    if (currentProblemIndex === 0 && !storyIntroShown) {
        const storyShown = showStoryIntro();
        if (storyShown) {
            return; // ストーリー表示後、ボタンから再度呼ばれる
        }
        storyIntroShown = true;
    }

    // ... 問題表示処理 ...
}
```

#### 3. ストーリーアウトロの表示（finishQuest）

```javascript
function finishQuest() {
    // ... 統計情報の計算 ...

    // クリアステータスを判定
    const clearStatus = accuracy >= 80 ? 'perfect' : accuracy >= 50 ? 'clear' : 'failed';

    // ストーリーアウトロを表示
    const storyShown = showStoryOutro(clearStatus);

    // ストーリーが表示されない場合は通常フロー
    if (!storyShown) {
        // ... 通常の完了処理 ...
    }
}
```

## 🎨 デザイン

### ストーリー画面のスタイル

- **背景**: 半透明の黒オーバーレイ（rgba(0, 0, 0, 0.95)）
- **コンテンツボックス**: 白背景、角丸、影付き
- **キャラクター表示**: アイコン・名前・タイプを表示
- **章タイトル**: グラデーション背景、大きめのフォント
- **ストーリーテキスト**: 読みやすい行間、適度な余白
- **NPCダイアログ**: 薄いグレー背景で強調
- **ボタン**: グラデーション、ホバーエフェクト付き

## 🚀 今後の拡張

### 未実装の学年

以下の学年のストーリーファイルを作成する必要があります：

- [ ] 小学1年（grade1-story.json）
- [ ] 小学3年（grade3-story.json）
- [ ] 小学5年（grade5-story.json）
- [ ] 小学6年（grade6-story.json）
- [ ] 中学2年（jh2-story.json）
- [ ] 中学3年（jh3-story.json）

### 追加機能のアイデア

1. **ストーリー選択肢**: プレイヤーの選択によってストーリーが分岐
2. **キャラクター別ストーリー**: 魔法使い・騎士などでストーリーが変化
3. **音声読み上げ**: ストーリーテキストの音声再生
4. **イラスト挿入**: キャラクター立ち絵やシーンイラスト
5. **ストーリーギャラリー**: 読んだストーリーを振り返る機能
6. **多言語対応**: 英語版のストーリーファイル

## 📝 ストーリー作成ガイドライン

新しいストーリーを作成する際の推奨事項：

1. **テーマ設定**: 学年の学習内容に合った冒険テーマを設定
2. **章構成**: 3-4章、各章2-5クエスト程度
3. **キャラクター**: NPCキャラクターを登場させ、継続性を持たせる
4. **難易度の物語化**: 学習内容の難易度上昇をストーリーで表現
5. **達成感**: 章・最終クエストでは大きな達成感を演出
6. **前後のつながり**: 各学年のストーリーに緩やかな連続性を持たせる

## 🧪 テスト方法

### 1. ストーリー表示のテスト

1. ワールドマップで優先学年（小2、小4、中1）のクエストを選択
2. ストーリーイントロが正しく表示されることを確認
3. 「クエスト開始」ボタンで問題が表示されることを確認
4. クエストをクリア
5. ストーリーアウトロが正しく表示されることを確認
6. 「次へ」ボタンでワールドマップに戻ることを確認

### 2. エラーハンドリングのテスト

1. ストーリーファイルが存在しない学年でクエストを開始
2. エラーが発生せず、通常通り問題が表示されることを確認
3. コンソールに「ストーリーファイルが見つかりません」が表示されることを確認

## ⚙️ 設定ファイル

### quest.html での読み込み順序

```html
<script src="js/hint-system.js"></script>
<script src="js/story-system.js"></script>  <!-- ストーリーシステム -->
<script src="js/progress-tracker.js"></script>
<script src="js/quest.js"></script>  <!-- quest.jsより前に読み込む -->
```

## 🎉 完成状況

### ✅ 完了済み

- [x] ストーリーシステムの基盤実装（story-system.js）
- [x] quest.jsへのストーリー統合
- [x] 中学1年ストーリー作成（8クエスト）
- [x] 小学4年ストーリー作成（14クエスト）
- [x] 小学2年ストーリー作成（10クエスト）

### 🔄 進行中

- [ ] 動作テストとデバッグ
- [ ] 残り6学年のストーリー作成

### 📅 次のステップ

1. **動作テスト**: ブラウザでストーリー表示をテスト
2. **バグ修正**: 発見された問題を修正
3. **ストーリー拡張**: 残り6学年のストーリー作成
4. **ユーザーテスト**: 実際のユーザーにプレイしてもらいフィードバック収集

---

**作成日**: 2025-01-11
**バージョン**: v2.1.0
