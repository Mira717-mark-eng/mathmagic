<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å®š - ãƒã‚¹ãƒã‚¸ï¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="min-h-screen fantasy-bg">
    <!-- æ˜Ÿã®èƒŒæ™¯ -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute w-2 h-2 bg-white rounded-full animate-pulse" style="top: 10%; left: 20%; opacity: 0.6;"></div>
        <div class="absolute w-1 h-1 bg-white rounded-full animate-pulse" style="top: 20%; left: 80%; opacity: 0.4;"></div>
        <div class="absolute w-2 h-2 bg-white rounded-full animate-pulse" style="top: 60%; left: 10%; opacity: 0.5;"></div>
        <div class="absolute w-1 h-1 bg-white rounded-full animate-pulse" style="top: 80%; left: 90%; opacity: 0.7;"></div>
        <div class="absolute w-2 h-2 bg-white rounded-full animate-pulse" style="top: 40%; left: 60%; opacity: 0.3;"></div>
    </div>

    <div class="container mx-auto px-4 py-8 relative z-10">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="dq-window p-6 mb-6 animate-fade-in">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="dq-gold-text text-4xl mb-2">âš™ï¸ è¨­å®š</h1>
                    <p class="text-white text-lg">ã‚²ãƒ¼ãƒ ã®è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã™</p>
                </div>
                <button onclick="goBack()" class="dq-button px-6 py-3 text-lg">
                    â† æˆ»ã‚‹
                </button>
            </div>
        </div>

        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ± -->
        <div class="dq-window p-6 mb-6 animate-fade-in" style="animation-delay: 0.1s;">
            <h2 class="dq-gold-text text-2xl mb-4">ğŸ‘¤ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±</h2>
            <div class="bg-white bg-opacity-10 rounded-lg p-4 mb-4">
                <div class="grid grid-cols-2 gap-4 text-white">
                    <div>
                        <div class="text-blue-200 text-sm">ãªã¾ãˆ</div>
                        <div class="text-xl font-bold" id="player-name">-</div>
                    </div>
                    <div>
                        <div class="text-blue-200 text-sm">å­¦å¹´</div>
                        <div class="text-xl font-bold" id="player-grade">-</div>
                    </div>
                    <div>
                        <div class="text-blue-200 text-sm">ãƒ¬ãƒ™ãƒ«</div>
                        <div class="text-xl font-bold" id="player-level">-</div>
                    </div>
                    <div>
                        <div class="text-blue-200 text-sm">æ­£ç­”ç‡</div>
                        <div class="text-xl font-bold" id="player-accuracy">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å­¦å¹´å¤‰æ›´ -->
        <div class="dq-window p-6 mb-6 animate-fade-in" style="animation-delay: 0.2s;">
            <h2 class="dq-gold-text text-2xl mb-4">ğŸ“š å­¦å¹´ã®å¤‰æ›´</h2>
            <div class="bg-white bg-opacity-10 rounded-lg p-4 mb-4">
                <p class="text-white mb-4">
                    å­¦å¹´ãŒä¸ŠãŒã£ãŸã‚‰ã€ã“ã“ã§å­¦å¹´ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚<br>
                    å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¯ãã®ã¾ã¾å¼•ãç¶™ãŒã‚Œã¾ã™ã€‚
                </p>
                <div class="flex gap-4">
                    <button onclick="changeGrade('up')" id="promote-btn" class="dq-button px-6 py-3 text-lg flex-1">
                        â¬†ï¸ å­¦å¹´ã‚’ä¸Šã’ã‚‹
                    </button>
                    <button onclick="changeGrade('down')" id="demote-btn" class="dq-button px-6 py-3 text-lg flex-1">
                        â¬‡ï¸ å­¦å¹´ã‚’ä¸‹ã’ã‚‹
                    </button>
                </div>
                <div class="mt-4 text-blue-200 text-sm" id="grade-info">
                    ç¾åœ¨ã®å­¦å¹´: <span id="current-grade-name">-</span>
                </div>
            </div>

            <!-- å­¦å¹´å±¥æ­´ -->
            <div class="bg-white bg-opacity-10 rounded-lg p-4">
                <h3 class="text-white text-lg font-bold mb-3">ğŸ“œ å­¦å¹´å±¥æ­´</h3>
                <div id="grade-history" class="space-y-2">
                    <!-- å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>

        <!-- ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š -->
        <div class="dq-window p-6 mb-6 animate-fade-in" style="animation-delay: 0.3s;">
            <h2 class="dq-gold-text text-2xl mb-4">ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š</h2>
            <div class="bg-white bg-opacity-10 rounded-lg p-4">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-white text-lg">åŠ¹æœéŸ³</span>
                    <button onclick="toggleSound()" id="sound-toggle" class="dq-button px-6 py-2">
                        <span id="sound-status">ON</span>
                    </button>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-white">éŸ³é‡</span>
                    <input type="range" min="0" max="100" value="50" id="volume-slider"
                           onchange="changeVolume(this.value)"
                           class="flex-1">
                    <span class="text-white" id="volume-display">50%</span>
                </div>
            </div>
        </div>

        <!-- é€²æ—çŠ¶æ³ -->
        <div class="dq-window p-6 mb-6 animate-fade-in" style="animation-delay: 0.4s;">
            <h2 class="dq-gold-text text-2xl mb-4">ğŸ“Š é€²æ—çŠ¶æ³</h2>
            <div class="bg-white bg-opacity-10 rounded-lg p-4">
                <div class="space-y-4 text-white">
                    <div>
                        <div class="flex justify-between mb-2">
                            <span>ç¾åœ¨ã®å­¦å¹´ã®ãƒ¯ãƒ¼ãƒ«ãƒ‰</span>
                            <span id="world-progress">0/0</span>
                        </div>
                        <div class="bg-gray-700 rounded-full h-4 overflow-hidden">
                            <div id="world-progress-bar" class="dq-hp-bar h-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-blue-200 text-sm">ç·å•é¡Œæ•°</div>
                            <div class="text-2xl font-bold" id="total-problems">0</div>
                        </div>
                        <div>
                            <div class="text-blue-200 text-sm">æ­£è§£æ•°</div>
                            <div class="text-2xl font-bold text-green-400" id="correct-problems">0</div>
                        </div>
                        <div>
                            <div class="text-blue-200 text-sm">ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆ</div>
                            <div class="text-2xl font-bold text-yellow-400" id="achievement-count">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
        <div class="dq-window p-6 animate-fade-in" style="animation-delay: 0.5s;">
            <h2 class="dq-gold-text text-2xl mb-4">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
            <div class="bg-white bg-opacity-10 rounded-lg p-4">
                <div class="space-y-3">
                    <button onclick="exportData()" class="dq-button w-full px-6 py-3 text-lg">
                        ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <button onclick="importData()" class="dq-button w-full px-6 py-3 text-lg">
                        ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <button onclick="resetData()" class="dq-button w-full px-6 py-3 text-lg bg-red-600 hover:bg-red-700">
                        ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
                    </button>
                </div>
                <p class="text-blue-200 text-sm mt-4">
                    âš ï¸ ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚<br>
                    å¿…è¦ã«å¿œã˜ã¦äº‹å‰ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚
                </p>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div id="confirm-dialog" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="dq-window p-8 max-w-md animate-zoom-in">
            <h3 class="dq-gold-text text-2xl mb-4" id="dialog-title">ç¢ºèª</h3>
            <p class="text-white text-lg mb-6" id="dialog-message">æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
            <div class="flex gap-4">
                <button onclick="confirmAction()" class="dq-button px-6 py-3 flex-1">
                    ã¯ã„
                </button>
                <button onclick="closeDialog()" class="dq-button px-6 py-3 flex-1">
                    ã„ã„ãˆ
                </button>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script src="js/player.js"></script>
    <script src="js/worlds.js"></script>
    <script src="js/sound-system.js"></script>
    <script src="js/achievement-system.js"></script>
    <script>
        let pendingAction = null;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', () => {
            SoundSystem.init();
            loadPlayerInfo();
            loadGradeHistory();
            loadProgress();
            loadSoundSettings();
        });

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
        function loadPlayerInfo() {
            const player = MathMagic.getCurrentPlayer();

            if (!player) {
                window.location.href = 'player-create.html';
                return;
            }

            document.getElementById('player-name').textContent = player.name;
            document.getElementById('player-grade').textContent = PlayerManager.getGradeName(player.grade);
            document.getElementById('player-level').textContent = `Lv.${player.level}`;
            document.getElementById('player-accuracy').textContent = `${PlayerManager.getAccuracy()}%`;
            document.getElementById('current-grade-name').textContent = PlayerManager.getGradeName(player.grade);

            // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
            document.getElementById('promote-btn').disabled = player.grade >= 9;
            document.getElementById('demote-btn').disabled = player.grade <= 1;
        }

        // å­¦å¹´å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
        function loadGradeHistory() {
            const history = PlayerManager.getGradeHistory();
            const container = document.getElementById('grade-history');

            if (history.length === 0) {
                container.innerHTML = '<p class="text-blue-200 text-sm">å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }

            container.innerHTML = history.map((entry, index) => {
                const date = new Date(entry.promotedAt);
                const dateStr = `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
                const reasonText = entry.reason === 'initial' ? 'åˆæœŸç™»éŒ²' :
                                   entry.reason === 'manual' ? 'æ‰‹å‹•å¤‰æ›´' :
                                   entry.reason === 'auto' ? 'è‡ªå‹•é€²ç´š' : entry.reason;

                return `
                    <div class="bg-white bg-opacity-5 rounded p-2 text-sm text-white">
                        <span class="font-bold">${PlayerManager.getGradeName(entry.grade)}</span>
                        <span class="text-blue-200">ï¼ˆ${dateStr} - ${reasonText}ï¼‰</span>
                    </div>
                `;
            }).reverse().join('');
        }

        // é€²æ—çŠ¶æ³ã‚’èª­ã¿è¾¼ã¿
        function loadProgress() {
            const player = MathMagic.getCurrentPlayer();

            if (!player) return;

            // ãƒ¯ãƒ¼ãƒ«ãƒ‰é€²æ—
            const gradeWorlds = getAvailableWorlds(player.grade);
            const completedWorlds = player.completedWorlds || [];
            const completedCount = gradeWorlds.filter(world =>
                completedWorlds.some(cw => cw.id === world.id && cw.completed)
            ).length;

            document.getElementById('world-progress').textContent = `${completedCount}/${gradeWorlds.length}`;
            const progressPercent = gradeWorlds.length > 0 ? (completedCount / gradeWorlds.length) * 100 : 0;
            document.getElementById('world-progress-bar').style.width = `${progressPercent}%`;

            // å•é¡Œæ•°
            document.getElementById('total-problems').textContent = player.totalProblems || 0;
            document.getElementById('correct-problems').textContent = player.correctProblems || 0;

            // ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆæ•°
            const achievements = player.achievements || [];
            document.getElementById('achievement-count').textContent = achievements.length;
        }

        // ã‚µã‚¦ãƒ³ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadSoundSettings() {
            const settings = MathMagic.getItem('soundSettings') || { enabled: true, volume: 0.5 };

            document.getElementById('sound-status').textContent = settings.enabled ? 'ON' : 'OFF';
            document.getElementById('volume-slider').value = Math.round(settings.volume * 100);
            document.getElementById('volume-display').textContent = `${Math.round(settings.volume * 100)}%`;
        }

        // å­¦å¹´å¤‰æ›´
        function changeGrade(direction) {
            const player = MathMagic.getCurrentPlayer();
            const currentGradeName = PlayerManager.getGradeName(player.grade);
            const newGrade = direction === 'up' ? player.grade + 1 : player.grade - 1;
            const newGradeName = PlayerManager.getGradeName(newGrade);

            const message = direction === 'up'
                ? `${currentGradeName}ã‹ã‚‰${newGradeName}ã«é€²ç´šã—ã¾ã™ã‹ï¼Ÿ\n\nå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¯ãã®ã¾ã¾å¼•ãç¶™ãŒã‚Œã¾ã™ã€‚`
                : `${currentGradeName}ã‹ã‚‰${newGradeName}ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ\n\nå¾©ç¿’ç”¨ã¨ã—ã¦å­¦å¹´ã‚’ä¸‹ã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`;

            showDialog('å­¦å¹´ã®å¤‰æ›´', message, () => {
                const result = direction === 'up'
                    ? PlayerManager.promoteGrade('manual')
                    : PlayerManager.demoteGrade('manual');

                if (result.success) {
                    SoundSystem.playSound('levelup');
                    showNotification(result.message, 'success');
                    loadPlayerInfo();
                    loadGradeHistory();
                    loadProgress();
                } else {
                    showNotification(result.error, 'error');
                }
            });
        }

        // ã‚µã‚¦ãƒ³ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleSound() {
            const enabled = SoundSystem.toggle();
            document.getElementById('sound-status').textContent = enabled ? 'ON' : 'OFF';
            SoundSystem.playSound('click');
        }

        // éŸ³é‡å¤‰æ›´
        function changeVolume(value) {
            const volume = value / 100;
            SoundSystem.setVolume(volume);
            document.getElementById('volume-display').textContent = `${value}%`;
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportData() {
            const player = MathMagic.getCurrentPlayer();
            const dataStr = JSON.stringify(player, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `mathmagic-${player.name}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();

                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        MathMagic.setItem('currentPlayer', data);
                        showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
                        loadPlayerInfo();
                        loadGradeHistory();
                        loadProgress();
                    } catch (error) {
                        showNotification('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                };

                reader.readAsText(file);
            };

            input.click();
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ
        function resetData() {
            showDialog(
                'ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚»ãƒƒãƒˆ',
                'âš ï¸ ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\næœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ',
                () => {
                    localStorage.clear();
                    showNotification('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
                    setTimeout(() => {
                        window.location.href = 'player-create.html';
                    }, 1500);
                }
            );
        }

        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
        function showDialog(title, message, onConfirm) {
            document.getElementById('dialog-title').textContent = title;
            document.getElementById('dialog-message').textContent = message;
            document.getElementById('confirm-dialog').classList.remove('hidden');
            pendingAction = onConfirm;
        }

        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        function closeDialog() {
            document.getElementById('confirm-dialog').classList.add('hidden');
            pendingAction = null;
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¢ºèª
        function confirmAction() {
            if (pendingAction) {
                pendingAction();
            }
            closeDialog();
        }

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 z-50 animate-bounce-in';
            notification.innerHTML = `
                <div class="dq-window p-4 max-w-sm">
                    <div class="text-white text-center">
                        ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'} ${message}
                    </div>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s ease';
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // æˆ»ã‚‹
        function goBack() {
            window.location.href = 'world-map.html';
        }
    </script>
</body>
</html>
